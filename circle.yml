machine:
  environment:
    FRONTEND_HOST: localhost
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker
dependencies:
  override:
    - docker info
    - sudo pip install Markdown==2.6.6
    - curl -L https://github.com/docker/compose/releases/download/1.6.0/docker-compose-`uname -s`-`uname -m` > $HOME/bin/docker-compose
    - chmod +x $HOME/bin/docker-compose
test:
  override:
    #
    #- sudo pip install coverage
    # TODO: coverage should be run in cotainer and data directory for output should be added as volume
    #- coverage run --source=tumbo tumbo/manage.py test core --settings=tumbo.dev
    #
    - sh -x build-worker.sh
    #
    - sudo pip install docopt==0.6.2
    - sudo pip install sh==1.11
    - sudo pip install Pygments==2.1.3
    - sudo pip install tabulate==0.7.5
    #
    - sed -i 's|/var/run/docker.sock|/run/docker.sock|g' docker-compose-app-docker_socket_exec.yml
    - cat docker-compose-app-docker_socket_exec.yml
    - egrep sock docker-compose-app-docker_socket_exec.yml
    #
    - sudo chmod 777 /run/docker.sock
    #
    - python cli/tumbo.py server docker pull
    - python cli/tumbo.py server docker build
    - python cli/tumbo.py server docker run:
        background: true
        timeout: 360
    - sleep 240
    - docker images
    - docker ps
    - docker ps -a
    - docker inspect tumboserver_app_1
    - curl --retry 10 --retry-delay 5 -v $(python cli/tumbo.py server docker url)
    - pkill python
    # Tests
    - docker run -e CIRCLECI=True -e CACHE_ENV_REDIS_PASS=aaa -e DROPBOX_CONSUMER_KEY=aa -e DROPBOX_CONSUMER_SECRET=aa -e DROPBOX_REDIRECT_URL=aa -i -t tumboserver_app /home/tumbo/.virtualenvs/tumbo/bin/python /home/tumbo/code/tumbo/manage.py test core --settings=tumbo.dev
    - docker run -e CIRCLECI=True -e CACHE_ENV_REDIS_PASS=aaa -e DROPBOX_CONSUMER_KEY=aa -e DROPBOX_CONSUMER_SECRET=aa -e DROPBOX_REDIRECT_URL=aa -i -t tumboserver_app /home/tumbo/.virtualenvs/tumbo/bin/python /home/tumbo/code/tumbo/manage.py test aaa --settings=tumbo.dev
    #
    #- sudo pip install codecov==2.0.5
    #- codecov -t $CODECOV_KEY
    #
    - markdown_py -o html5 -f tumbo/ui/templates/docs_content.html docs/user_guide.md
    - git config --global user.email "philip@sahli.net"
    - git config --global user.name "Philip Sahli"
    - git commit tumbo/ui/templates/docs*.html -m "update docs [ci skip]" || true
    #
    #- "PORT=$(docker-compose -f docker-compose-app-spawnproc.yml port lb 80|awk -F: '{print $2}'); curl --retry 10 --retry-delay 5 -v http://localhost:$PORT"
deployment:
  release:
    branch: master
    commands:
      # publish master tag
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag tumboserver_app philipsahli/tumbo-server:master
      - docker tag philipsahli/tumbo-worker:develop philipsahli/tumbo-worker:master
      - docker images
      - docker push philipsahli/tumbo-server:master
      - docker push philipsahli/tumbo-worker:master
  trunk:
    branch: develop
    commands:
      # publish develop tag
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag tumboserver_app philipsahli/tumbo-server:develop
      - docker images
      - docker push philipsahli/tumbo-server:develop
      - docker push philipsahli/tumbo-worker:develop
    branch: social-auth
    commands:
      # publish develop tag
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag tumboserver_app philipsahli/tumbo-server:$CIRCLE_BRANCH
      - docker tag philipsahli/tumbo-worker:develop philipsahli/tumbo-worker:$CIRCLE_BRANCH
      - docker images
      - docker push philipsahli/tumbo-server:$CIRCLE_BRANCH
      - docker push philipsahli/tumbo-worker:$CIRCLE_BRANCH
